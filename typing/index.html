<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>50Èü≥„Çø„Ç§„Éî„É≥„Ç∞Á∑¥Áøí</title>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Dots&family=Noto+Sans+Mono:wght@400;700&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg:     #0f0f1a;
            --card:   rgba(255,255,255,0.05);
            --border: rgba(255,255,255,0.1);
            --gold:   #ffd60a;
            --red:    #e63946;
            --c-boin:      #ff8c00;
            --c-gyou:      #4cc9f0;
            --c-dakuon:    #a855f7;
            --c-tokubetsu: #4ade80;
            --c-nobashi:   #f72585;
            --c-gairai:    #00b4d8;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: var(--bg);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }
        body::before {
            content: '';
            position: fixed; inset: 0;
            background:
                repeating-linear-gradient(90deg, rgba(255,255,255,0.013) 0,rgba(255,255,255,0.013) 1px,transparent 1px,transparent 60px),
                repeating-linear-gradient(0deg,  rgba(255,255,255,0.013) 0,rgba(255,255,255,0.013) 1px,transparent 1px,transparent 60px);
            pointer-events: none; z-index: 0;
        }

        /* ===== ÁîªÈù¢ÁÆ°ÁêÜ ===== */
        .screen {
            display: none; min-height: 100vh; position: relative; z-index: 1;
            flex-direction: column; align-items: center; justify-content: center;
            padding: 24px 16px;
        }
        .screen.active { display: flex; }

        /* ===== ÂÖ±ÈÄö ===== */
        .page-header {
            position: absolute; top: 0; left: 0; right: 0;
            display: flex; align-items: center; gap: 12px; padding: 14px 18px;
        }
        .btn-back {
            background: transparent;
            border: 1.5px solid rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.6);
            padding: 7px 14px; border-radius: 6px;
            cursor: pointer; font-size: 13px;
            font-family: 'Noto Sans JP', sans-serif;
            transition: all 0.15s;
        }
        .btn-back:hover { border-color: white; color: white; }
        .page-label {
            font-size: 12px; letter-spacing: 3px;
            color: rgba(255,255,255,0.35); font-weight: 700;
        }

        /* ===== „Çø„Ç§„Éà„É´ ===== */
        .title-logo { text-align: center; margin-bottom: 44px; }
        .title-icon { font-size: 52px; margin-bottom: 14px; }
        .title-main {
            font-family: 'Noto Sans JP', sans-serif;
            font-weight: 400;
            font-size: clamp(38px, 9vw, 76px);
            line-height: 1.2;
        }
        .title-line1 {
            display: block;
            background: linear-gradient(90deg,#ff8c00,#ffb700);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 0 14px rgba(255,140,0,0.5));
        }
        .title-line2 {
            display: block;
            background: linear-gradient(90deg,#ff4d4d,#ff2060);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 0 14px rgba(255,50,80,0.5));
        }
        .title-sub {
            font-size: 13px; color: rgba(255,255,255,0.38);
            letter-spacing: 2px; margin-top: 10px;
        }

        /* „Çø„Ç§„Éà„É´„Éú„Çø„É≥ 2Ë°å */
        .title-btn-wrap { display: flex; flex-direction: column; gap: 10px; width: 100%; max-width: 400px; }
        .btn-row { display: flex; gap: 10px; justify-content: center; }
        .btn-mode {
            flex: 1; max-width: 120px;
            padding: 16px 8px;
            border: none; border-radius: 50px;
            cursor: pointer;
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 17px; font-weight: 900;
            letter-spacing: 2px;
            color: #0f0f1a;
            transition: all 0.15s;
        }
        .btn-mode:active { transform: scale(0.95); }
        .btn-mode:hover { transform: translateY(-2px); }

        .c-boin-btn      { background: linear-gradient(135deg,#ff8c00,#e6a817); box-shadow: 0 3px 16px rgba(255,140,0,0.4); }
        .c-gyou-btn      { background: linear-gradient(135deg,#4cc9f0,#3a86ff); box-shadow: 0 3px 16px rgba(76,201,240,0.4); }
        .c-dakuon-btn    { background: linear-gradient(135deg,#a855f7,#7c3aed); color: white; box-shadow: 0 3px 16px rgba(168,85,247,0.4); }
        .c-tokubetsu-btn { background: linear-gradient(135deg,#4ade80,#16a34a); box-shadow: 0 3px 16px rgba(74,222,128,0.4); }
        .c-nobashi-btn   { background: linear-gradient(135deg,#f72585,#b5179e); color: white; box-shadow: 0 3px 16px rgba(247,37,133,0.4); }
        .c-gairai-btn    { background: linear-gradient(135deg,#00b4d8,#0077b6); color: white; box-shadow: 0 3px 16px rgba(0,180,216,0.4); }

        /* ===== ÈÅ∏ÊäûÁîªÈù¢ ===== */
        #screen-select { justify-content: flex-start; padding-top: 80px; }
        .select-heading { text-align: center; margin-bottom: 20px; }
        .select-heading h2 { font-size: 19px; font-weight: 900; margin-bottom: 4px; }
        .select-heading p  { font-size: 12px; color: rgba(255,255,255,0.38); }

        .select-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px; width: 100%; max-width: 460px;
        }
        .select-btn {
            background: var(--card);
            border: 1.5px solid var(--border);
            border-radius: 12px; padding: 16px 14px;
            cursor: pointer; transition: all 0.2s;
            text-align: left; color: white;
            font-family: 'Noto Sans JP', sans-serif; width: 100%;
        }
        .select-btn:hover { background: rgba(255,255,255,0.09); transform: translateY(-2px); }
        .sn  { font-family:'Zen Dots',cursive; font-size:10px; letter-spacing:2px; margin-bottom:8px; }
        .sm  { font-size:20px; font-weight:900; margin-bottom:4px; }
        .sk  { font-family:'Noto Sans Mono',monospace; font-size:11px; color:rgba(255,255,255,0.38); }

        /* „Åæ„Å®„ÇÅ„Å¶„Éú„Çø„É≥Ôºà1ÂàóÂÖ®ÂπÖÔºâ */
        .btn-matomete {
            grid-column: 1 / -1;
            background: rgba(255,255,255,0.07);
            border: 1.5px dashed rgba(255,255,255,0.2);
            border-radius: 12px; padding: 14px;
            cursor: pointer; color: white;
            font-family:'Noto Sans JP',sans-serif;
            font-size:16px; font-weight:900;
            letter-spacing:3px; text-align:center;
            transition: all 0.2s; width:100%;
        }
        .btn-matomete:hover { background:rgba(255,255,255,0.12); transform:translateY(-1px); }

        /* „É¢„Éº„ÉâÂà•„Éú„Éº„ÉÄ„ÉºËâ≤ */
        .mode-boin      .select-btn { border-color:rgba(255,140,0,0.3); }
        .mode-boin      .select-btn:hover { border-color:var(--c-boin); }
        .mode-boin      .sn { color:var(--c-boin); }
        .mode-gyou      .select-btn { border-color:rgba(76,201,240,0.3); }
        .mode-gyou      .select-btn:hover { border-color:var(--c-gyou); }
        .mode-gyou      .sn { color:var(--c-gyou); }
        .mode-dakuon    .select-btn { border-color:rgba(168,85,247,0.3); }
        .mode-dakuon    .select-btn:hover { border-color:var(--c-dakuon); }
        .mode-dakuon    .sn { color:var(--c-dakuon); }
        .mode-tokubetsu .select-btn { border-color:rgba(74,222,128,0.3); }
        .mode-tokubetsu .select-btn:hover { border-color:var(--c-tokubetsu); }
        .mode-tokubetsu .sn { color:var(--c-tokubetsu); }
        .mode-nobashi   .select-btn { border-color:rgba(247,37,133,0.3); }
        .mode-nobashi   .select-btn:hover { border-color:var(--c-nobashi); }
        .mode-nobashi   .sn { color:var(--c-nobashi); }
        .mode-gairai    .select-btn { border-color:rgba(0,180,216,0.3); }
        .mode-gairai    .select-btn:hover { border-color:var(--c-gairai); }
        .mode-gairai    .sn { color:var(--c-gairai); }

        /* ===== „Ç≤„Éº„É†ÁîªÈù¢ ===== */
        #screen-game { justify-content: flex-start; padding-top: 72px; }

        .game-top {
            position:absolute; top:0; left:0; right:0;
            display:flex; align-items:center; gap:10px; padding:13px 18px;
        }
        .game-badge {
            font-family:'Zen Dots',cursive; font-size:11px;
            letter-spacing:2px; padding:4px 12px; border-radius:20px;
            color:#0f0f1a;
        }
        .gb-boin      { background:var(--c-boin); }
        .gb-gyou      { background:var(--c-gyou); }
        .gb-dakuon    { background:var(--c-dakuon); color:white; }
        .gb-tokubetsu { background:var(--c-tokubetsu); }
        .gb-nobashi   { background:var(--c-nobashi); color:white; }
        .gb-gairai    { background:var(--c-gairai);  color:white; }

        .game-prog {
            margin-left:auto;
            font-family:'Noto Sans Mono',monospace;
            font-size:13px; color:rgba(255,255,255,0.38);
        }

        /* „Ç≠„É£„É©„Ç´„Éº„Éâ */
        .char-card {
            background:var(--card);
            border:1px solid var(--border);
            border-radius:20px;
            width:100%; max-width:440px;
            padding:32px 28px 24px;
            text-align:center; margin-bottom:18px;
        }
        .char-context {
            font-size:11px; letter-spacing:3px;
            color:rgba(255,255,255,0.28); font-weight:700; margin-bottom:10px;
        }
        .char-display {
            font-weight:900; line-height:1.1;
            margin-bottom:6px;
            transition: font-size 0.1s;
        }
        .size-lg  { font-size:76px; }
        .size-md  { font-size:48px; }
        .size-sm  { font-size:34px; }
        .size-xs  { font-size:26px; }

        /* „ÅÆ„Å∞„ÅóÊº¢Â≠óË°®Á§∫ */
        .char-kanji {
            font-size: 22px;
            color: rgba(255,255,255,0.55);
            letter-spacing: 3px;
            margin-bottom: 6px;
            min-height: 28px;
            font-weight: 700;
        }

        /* „É≠„Éº„ÉûÂ≠ó„Éú„ÉÉ„ÇØ„Çπ */
        .romaji-wrap { width:100%; max-width:440px; margin-bottom:14px; }
        .romaji-display {
            display:flex; justify-content:center;
            gap:6px; flex-wrap:wrap;
            min-height:54px; align-items:center;
        }
        .r-box {
            height:52px;
            border:2px solid rgba(255,255,255,0.12);
            border-radius:7px;
            display:flex; align-items:center; justify-content:center;
            font-family:'Noto Sans Mono',monospace;
            font-weight:700;
            color:rgba(255,255,255,0.15);
            background:rgba(255,255,255,0.03);
            transition:all 0.1s;
        }
        .r-box-wide { width:44px; font-size:22px; }
        .r-box-narrow { width:36px; font-size:18px; }

        .r-box.typed {
            color:white;
            border-color:rgba(255,255,255,0.4);
            background:rgba(255,255,255,0.07);
        }
        .r-box.cur-boin      { border-color:var(--c-boin);      background:rgba(255,140,0,0.1);   box-shadow:0 0 10px rgba(255,140,0,0.3);   color:rgba(255,255,255,0.5); }
        .r-box.cur-gyou      { border-color:var(--c-gyou);      background:rgba(76,201,240,0.1);  box-shadow:0 0 10px rgba(76,201,240,0.3);  color:rgba(255,255,255,0.5); }
        .r-box.cur-dakuon    { border-color:var(--c-dakuon);    background:rgba(168,85,247,0.1);  box-shadow:0 0 10px rgba(168,85,247,0.3);  color:rgba(255,255,255,0.5); }
        .r-box.cur-tokubetsu { border-color:var(--c-tokubetsu); background:rgba(74,222,128,0.1);  box-shadow:0 0 10px rgba(74,222,128,0.3);  color:rgba(255,255,255,0.5); }
        .r-box.cur-nobashi   { border-color:var(--c-nobashi);   background:rgba(247,37,133,0.1);  box-shadow:0 0 10px rgba(247,37,133,0.3);  color:rgba(255,255,255,0.5); }
        .r-box.cur-gairai    { border-color:var(--c-gairai);    background:rgba(0,180,216,0.1);   box-shadow:0 0 10px rgba(0,180,216,0.3);   color:rgba(255,255,255,0.5); }
        .r-box.wrong {
            border-color:var(--red);
            background:rgba(230,57,70,0.15);
            animation:shake 0.3s ease;
        }
        @keyframes shake {
            0%,100% { transform:translateX(0); }
            25%     { transform:translateX(-5px); }
            75%     { transform:translateX(5px); }
        }
        @keyframes cardPop {
            0%,100% { transform:scale(1); }
            40%     { transform:scale(1.04); }
        }
        .char-card.pop { animation:cardPop 0.32s ease; }

        /* ===== Á¥ôÂêπÈõ™„Éë„Éº„ÉÜ„Ç£„ÇØ„É´ ===== */
        .confetti-piece {
            position: fixed;
            pointer-events: none;
            z-index: 999;
            font-size: 18px;
            animation: confettiFly var(--dur) ease-out forwards;
        }
        @keyframes confettiFly {
            0%   { transform: translate(0,0) rotate(0deg) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) rotate(var(--rot)) scale(0.3); opacity: 0; }
        }

        /* ===== Ëä±ÁÅ´„Ç≠„É£„É≥„Éê„Çπ ===== */
        #fireworks-canvas {
            position: fixed; inset: 0;
            pointer-events: none;
            z-index: 100;
        }

        /* ===== „ÅÆ„Å∞„ÅóÁµµÊñáÂ≠ó ===== */
        .char-emoji {
            font-size: 52px;
            line-height: 1;
            margin-bottom: 4px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ÈÄ≤Êçó„Éâ„ÉÉ„Éà */
        .progress-dots {
            display:flex; gap:6px; justify-content:center;
            margin-top:14px; flex-wrap:wrap; max-width:440px;
        }
        .dot { width:8px; height:8px; border-radius:50%; background:rgba(255,255,255,0.14); transition:all 0.2s; }
        .dot.done-boin       { background:var(--c-boin); }
        .dot.done-gyou       { background:var(--c-gyou); }
        .dot.done-dakuon     { background:var(--c-dakuon); }
        .dot.done-tokubetsu  { background:var(--c-tokubetsu); }
        .dot.done-nobashi    { background:var(--c-nobashi); }
        .dot.done-gairai     { background:var(--c-gairai); }
        .dot.act-boin        { background:var(--c-boin);      box-shadow:0 0 7px var(--c-boin);      transform:scale(1.4); }
        .dot.act-gyou        { background:var(--c-gyou);      box-shadow:0 0 7px var(--c-gyou);      transform:scale(1.4); }
        .dot.act-dakuon      { background:var(--c-dakuon);    box-shadow:0 0 7px var(--c-dakuon);    transform:scale(1.4); }
        .dot.act-tokubetsu   { background:var(--c-tokubetsu); box-shadow:0 0 7px var(--c-tokubetsu); transform:scale(1.4); }
        .dot.act-nobashi     { background:var(--c-nobashi);   box-shadow:0 0 7px var(--c-nobashi);   transform:scale(1.4); }
        .dot.act-gairai      { background:var(--c-gairai);    box-shadow:0 0 7px var(--c-gairai);    transform:scale(1.4); }

        .tap-hint { font-size:12px; color:rgba(255,255,255,0.2); letter-spacing:2px; text-align:center; margin-top:12px; }

        .hidden-input {
            position:absolute; opacity:0;
            pointer-events:none; width:1px; height:1px;
        }

        /* „ÅØ„Åò„ÇÅ„Çã„Ç™„Éº„Éê„Éº„É¨„Ç§ */
        #start-overlay {
            position:fixed; inset:0; z-index:200;
            display:flex; align-items:center; justify-content:center;
            background:rgba(15,15,26,0.82); backdrop-filter:blur(4px);
        }
        .btn-start-overlay {
            border:none; border-radius:50px;
            padding:20px 52px;
            font-family:'Noto Sans JP',sans-serif;
            font-size:22px; font-weight:900; letter-spacing:3px;
            cursor:pointer;
            background:linear-gradient(135deg,#ffd60a,#ffb700);
            color:#0f0f1a;
            box-shadow:0 4px 24px rgba(255,214,10,0.45);
            transition:all 0.15s;
        }
        .btn-start-overlay:hover { transform:translateY(-2px); box-shadow:0 6px 32px rgba(255,214,10,0.6); }

        /* ===== ÁµêÊûúÁîªÈù¢ ===== */
        .result-box { text-align:center; max-width:360px; width:100%; }
        .result-icon { font-size:60px; margin-bottom:10px; }
        .result-msg  { font-size:24px; font-weight:900; margin-bottom:20px; }
        .result-stats {
            background:var(--card); border:1px solid var(--border);
            border-radius:12px; padding:18px; margin-bottom:24px;
        }
        .rs-label { font-size:11px; letter-spacing:3px; color:rgba(255,255,255,0.32); margin-bottom:4px; }
        .rs-val {
            font-family:'Zen Dots',cursive; font-size:46px;
            color:var(--gold); text-shadow:0 0 20px rgba(255,214,10,0.4);
        }
        .result-btns { display:flex; flex-direction:column; gap:10px; }
        .btn-res {
            padding:15px 28px; border:none; border-radius:50px;
            cursor:pointer; font-family:'Noto Sans JP',sans-serif;
            font-size:16px; font-weight:900; letter-spacing:2px;
            transition:all 0.15s;
        }
        .btn-res:hover { opacity:0.85; transform:translateY(-1px); }
        .btn-retry  { background:var(--gold); color:#0f0f1a; }
        .btn-next   { background:linear-gradient(135deg,#4cc9f0,#3a86ff); color:white; }
        .btn-home   { background:rgba(255,255,255,0.08); color:white; border:1px solid rgba(255,255,255,0.15); }

        /* ===== „É¨„Çπ„Éù„É≥„Ç∑„Éñ ===== */
        @media (max-width:380px) {
            .title-main { font-size:34px; }
            .btn-mode { font-size:15px; padding:14px 6px; }
            .r-box-wide { width:38px; font-size:19px; }
            .r-box-narrow { width:30px; font-size:15px; }
            .select-grid { grid-template-columns:1fr; }
        }
    </style>
</head>
<body>

<!-- ===== „Çø„Ç§„Éà„É´ ===== -->
<div id="screen-title" class="screen active">
    <div class="title-logo">
        <div class="title-icon">‚öîÔ∏è</div>
        <div class="title-main">
            <span class="title-line1">50Èü≥</span>
            <span class="title-line2">„Çø„Ç§„Éî„É≥„Ç∞</span>
        </div>
        <div class="title-sub">„É≠„Éº„ÉûÂ≠ó„Çí„ÅÜ„Å°„Å™„Åå„Çâ„Åä„Åº„Åà„Çà„ÅÜ</div>
    </div>
    <div class="title-btn-wrap">
        <div class="btn-row">
            <button class="btn-mode c-boin-btn"   onclick="selectMode('boin')">ÊØçÈü≥</button>
            <button class="btn-mode c-gyou-btn"   onclick="selectMode('gyou')">Ë°å</button>
            <button class="btn-mode c-dakuon-btn" onclick="selectMode('dakuon')">ÊøÅÈü≥</button>
        </div>
        <div class="btn-row">
            <button class="btn-mode c-tokubetsu-btn" onclick="selectMode('tokubetsu')">ÁâπÊÆä</button>
            <button class="btn-mode c-nobashi-btn"   onclick="selectMode('nobashi')">„ÅÆ„Å∞„Åó</button>
            <button class="btn-mode c-gairai-btn"    onclick="selectMode('gairai')">Â§ñÊù•Ë™û</button>
        </div>
    </div>
</div>

<!-- ===== ÈÅ∏ÊäûÁîªÈù¢ ===== -->
<div id="screen-select" class="screen">
    <div class="page-header">
        <button class="btn-back" onclick="goTo('title')">‚Üê „ÇÇ„Å©„Çã</button>
        <span class="page-label" id="sel-label"></span>
    </div>
    <div class="select-heading">
        <h2 id="sel-heading"></h2>
        <p  id="sel-sub"></p>
    </div>
    <div class="select-grid" id="sel-grid"></div>
</div>

<!-- ===== „Ç≤„Éº„É†ÁîªÈù¢ ===== -->
<div id="screen-game" class="screen">
    <div class="game-top">
        <button class="btn-back" onclick="quitGame()">‚Üê „ÇÑ„ÇÅ„Çã</button>
        <span class="game-badge" id="game-badge">ÊØçÈü≥</span>
        <span class="game-prog"  id="game-prog">1 / 5</span>
    </div>

    <div class="char-card" id="char-card">
        <div class="char-context" id="char-ctx">„ÅÇÊÆµ</div>
        <div class="char-emoji"   id="char-emoji"></div>
        <div class="char-kanji"   id="char-kanji"></div>
        <div class="char-display size-lg" id="char-disp">„ÅÇ</div>
    </div>

    <div class="romaji-wrap">
        <div class="romaji-display" id="romaji-disp"></div>
    </div>

    <div class="progress-dots" id="prog-dots"></div>

    <input type="text" class="hidden-input" id="hidden-input"
        autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false">

    <div id="start-overlay" style="display:none;">
        <button class="btn-start-overlay" onclick="activateInput()">‚ñ∂ „ÅØ„Åò„ÇÅ„Çã</button>
    </div>
</div>

<!-- ===== ÁµêÊûúÁîªÈù¢ ===== -->
<div id="screen-result" class="screen">
    <div class="result-box">
        <div class="result-icon">üéâ</div>
        <div class="result-msg" id="res-msg">„Åú„Çì„Å∂„Åß„Åç„ÅüÔºÅ</div>
        <div class="result-stats">
            <div class="rs-label">„ÇØ„É™„Ç¢„Åó„ÅüÊñáÂ≠óÊï∞</div>
            <div class="rs-val" id="res-count">0</div>
            <div class="rs-label" style="margin-top:4px;">„ÇÇ„Åò</div>
        </div>
        <div class="result-btns">
            <button class="btn-res btn-retry" onclick="retryGame()">üîÑ „ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
            <button class="btn-res btn-next"  id="btn-next" style="display:none;">‚ñ∂ Ê¨°„Å∏</button>
            <button class="btn-res btn-home"  onclick="goTo('title')">üè† „Éõ„Éº„É†„Å∏</button>
        </div>
    </div>
<!-- Ëä±ÁÅ´„Ç≠„É£„É≥„Éê„Çπ -->
<canvas id="fireworks-canvas"></canvas>

</div>

<script>
// =====================================================
// „Éá„Éº„Çø
// =====================================================

const boinData = {
    '„ÅÇÊÆµ': [{k:'„ÅÇ',r:'a'},{k:'„Åã',r:'ka'},{k:'„Åï',r:'sa'},{k:'„Åü',r:'ta'},{k:'„Å™',r:'na'},{k:'„ÅØ',r:'ha'},{k:'„Åæ',r:'ma'},{k:'„ÇÑ',r:'ya'},{k:'„Çâ',r:'ra'},{k:'„Çè',r:'wa'}],
    '„ÅÑÊÆµ': [{k:'„ÅÑ',r:'i'},{k:'„Åç',r:'ki'},{k:'„Åó',r:'shi'},{k:'„Å°',r:'ti'},{k:'„Å´',r:'ni'},{k:'„Å≤',r:'hi'},{k:'„Åø',r:'mi'},{k:'„Çä',r:'ri'}],
    '„ÅÜÊÆµ': [{k:'„ÅÜ',r:'u'},{k:'„Åè',r:'ku'},{k:'„Åô',r:'su'},{k:'„Å§',r:'tsu'},{k:'„Å¨',r:'nu'},{k:'„Åµ',r:'fu'},{k:'„ÇÄ',r:'mu'},{k:'„ÇÜ',r:'yu'},{k:'„Çã',r:'ru'}],
    '„ÅàÊÆµ': [{k:'„Åà',r:'e'},{k:'„Åë',r:'ke'},{k:'„Åõ',r:'se'},{k:'„Å¶',r:'te'},{k:'„Å≠',r:'ne'},{k:'„Å∏',r:'he'},{k:'„ÇÅ',r:'me'},{k:'„Çå',r:'re'}],
    '„ÅäÊÆµ': [{k:'„Åä',r:'o'},{k:'„Åì',r:'ko'},{k:'„Åù',r:'so'},{k:'„Å®',r:'to'},{k:'„ÅÆ',r:'no'},{k:'„Åª',r:'ho'},{k:'„ÇÇ',r:'mo'},{k:'„Çà',r:'yo'},{k:'„Çç',r:'ro'},{k:'„Çí',r:'wo'}],
};

const gyouData = {
    '„ÅÇË°å': [{k:'„ÅÇ',r:'a'},{k:'„ÅÑ',r:'i'},{k:'„ÅÜ',r:'u'},{k:'„Åà',r:'e'},{k:'„Åä',r:'o'}],
    '„ÅãË°å': [{k:'„Åã',r:'ka'},{k:'„Åç',r:'ki'},{k:'„Åè',r:'ku'},{k:'„Åë',r:'ke'},{k:'„Åì',r:'ko'}],
    '„ÅïË°å': [{k:'„Åï',r:'sa'},{k:'„Åó',r:'shi'},{k:'„Åô',r:'su'},{k:'„Åõ',r:'se'},{k:'„Åù',r:'so'}],
    '„ÅüË°å': [{k:'„Åü',r:'ta'},{k:'„Å°',r:'ti'},{k:'„Å§',r:'tsu'},{k:'„Å¶',r:'te'},{k:'„Å®',r:'to'}],
    '„Å™Ë°å': [{k:'„Å™',r:'na'},{k:'„Å´',r:'ni'},{k:'„Å¨',r:'nu'},{k:'„Å≠',r:'ne'},{k:'„ÅÆ',r:'no'}],
    '„ÅØË°å': [{k:'„ÅØ',r:'ha'},{k:'„Å≤',r:'hi'},{k:'„Åµ',r:'fu'},{k:'„Å∏',r:'he'},{k:'„Åª',r:'ho'}],
    '„ÅæË°å': [{k:'„Åæ',r:'ma'},{k:'„Åø',r:'mi'},{k:'„ÇÄ',r:'mu'},{k:'„ÇÅ',r:'me'},{k:'„ÇÇ',r:'mo'}],
    '„ÇÑË°å': [{k:'„ÇÑ',r:'ya'},{k:'„ÇÜ',r:'yu'},{k:'„Çà',r:'yo'}],
    '„ÇâË°å': [{k:'„Çâ',r:'ra'},{k:'„Çä',r:'ri'},{k:'„Çã',r:'ru'},{k:'„Çå',r:'re'},{k:'„Çç',r:'ro'}],
    '„ÇèË°å': [{k:'„Çè',r:'wa'},{k:'„Çí',r:'wo'},{k:'„Çì',r:'nn'}],
};

const dakuonData = {
    '„ÅåË°å': [{k:'„Åå',r:'ga'},{k:'„Åé',r:'gi'},{k:'„Åê',r:'gu'},{k:'„Åí',r:'ge'},{k:'„Åî',r:'go'}],
    '„ÅñË°å': [{k:'„Åñ',r:'za'},{k:'„Åò',r:'ji'},{k:'„Åö',r:'zu'},{k:'„Åú',r:'ze'},{k:'„Åû',r:'zo'}],
    '„Å†Ë°å': [{k:'„Å†',r:'da'},{k:'„Å¢',r:'di'},{k:'„Å•',r:'du'},{k:'„Åß',r:'de'},{k:'„Å©',r:'do'}],
    '„Å∞Ë°å': [{k:'„Å∞',r:'ba'},{k:'„Å≥',r:'bi'},{k:'„Å∂',r:'bu'},{k:'„Åπ',r:'be'},{k:'„Åº',r:'bo'}],
    '„Å±Ë°å': [{k:'„Å±',r:'pa'},{k:'„Å¥',r:'pi'},{k:'„Å∑',r:'pu'},{k:'„Å∫',r:'pe'},{k:'„ÅΩ',r:'po'}],
};

const tokubetsuData = {
    '„Åç„ÇÉË°å': [{k:'„Åç„ÇÉ',r:'kya'},{k:'„Åç„ÇÖ',r:'kyu'},{k:'„Åç„Çá',r:'kyo'}],
    '„Åó„ÇÉË°å': [{k:'„Åó„ÇÉ',r:'sha'},{k:'„Åó„ÇÖ',r:'shu'},{k:'„Åó„Çá',r:'sho'}],
    '„Å°„ÇÉË°å': [{k:'„Å°„ÇÉ',r:'tya'},{k:'„Å°„ÇÖ',r:'tyu'},{k:'„Å°„Çá',r:'tyo'}],
    '„Å´„ÇÉË°å': [{k:'„Å´„ÇÉ',r:'nya'},{k:'„Å´„ÇÖ',r:'nyu'},{k:'„Å´„Çá',r:'nyo'}],
    '„Å≤„ÇÉË°å': [{k:'„Å≤„ÇÉ',r:'hya'},{k:'„Å≤„ÇÖ',r:'hyu'},{k:'„Å≤„Çá',r:'hyo'}],
    '„Åø„ÇÉË°å': [{k:'„Åø„ÇÉ',r:'mya'},{k:'„Åø„ÇÖ',r:'myu'},{k:'„Åø„Çá',r:'myo'}],
    '„Çä„ÇÉË°å': [{k:'„Çä„ÇÉ',r:'rya'},{k:'„Çä„ÇÖ',r:'ryu'},{k:'„Çä„Çá',r:'ryo'}],
    '„Åé„ÇÉË°å': [{k:'„Åé„ÇÉ',r:'gya'},{k:'„Åé„ÇÖ',r:'gyu'},{k:'„Åé„Çá',r:'gyo'}],
    '„Åò„ÇÉË°å': [{k:'„Åò„ÇÉ',r:'ja'}, {k:'„Åò„ÇÖ',r:'ju'}, {k:'„Åò„Çá',r:'jo'}],
    '„Å≥„ÇÉË°å': [{k:'„Å≥„ÇÉ',r:'bya'},{k:'„Å≥„ÇÖ',r:'byu'},{k:'„Å≥„Çá',r:'byo'}],
    '„Å¥„ÇÉË°å': [{k:'„Å¥„ÇÉ',r:'pya'},{k:'„Å¥„ÇÖ',r:'pyu'},{k:'„Å¥„Çá',r:'pyo'}],
    '„Å£ÔºàltuÔºâ': [{k:'„Å£',r:'ltu'},{k:'„Å£',r:'ltu'},{k:'„Å£',r:'ltu'},{k:'„Å£',r:'ltu'},{k:'„Å£',r:'ltu'}],
    '‰øÉÈü≥Ë™û': [
        {k:'„Åç„Å£„Å¶',  r:'kitte',  j:'ÂàáÊâã'},
        {k:'„Åç„Å£„Å∑',  r:'kippu',  j:'ÂàáÁ¨¶'},
        {k:'„Åñ„Å£„Åó',  r:'zasshi', j:'ÈõëË™å'},
        {k:'„ÇÇ„Å£„Å®',  r:'motto',  j:'„ÇÇ„Å£„Å®'},
        {k:'„Åç„Å£„Å®',  r:'kitto',  j:'„Åç„Å£„Å®'},
        {k:'„ÅØ„Å£„Å±',  r:'happa',  j:'Ëëâ„Å£„Å±'},
        {k:'„ÅÑ„Å£„ÅΩ',  r:'ippo',   j:'‰∏ÄÊ≠©'},
        {k:'„Å≠„Å£„Åì',  r:'nekko',  j:'Ê†π„Å£„Åì'},
        {k:'„ÅÑ„Å£„Åã',  r:'ikka',   j:'‰∏ÄÂÆ∂'},
        {k:'„Åñ„Å£„Åã',  r:'zakka',  j:'ÈõëË≤®'},
        {k:'„Åï„Å£„Åã',  r:'sakka',  j:'‰ΩúÂÆ∂'},
        {k:'„ÅÑ„Å£„Åç',  r:'ikki',   j:'‰∏ÄÊ∞ó'},
        {k:'„Çç„Å£„Åã',  r:'rokka',  j:'„É≠„ÉÉ„Ç´„Éº'},
        {k:'„Åï„Å£„Åï',  r:'sassa',  j:'„Åï„Å£„Åï„Å®'},
        {k:'„Åº„Å£„Å°',  r:'botti',  j:'„Åº„Å£„Å°'},
    ],
};

const nobashiData = {
    '„ÉºÔºàÂ§ñÊù•Ë™ûÔºâ': [
        {k:'„Çâ„Éº„ÇÅ„Çì',    r:'ra-menn',     j:'ÊãâÈ∫∫',         e:'üçú'},
        {k:'„Åã„Çå„Éº',      r:'kare-',       j:'„Ç´„É¨„Éº',       e:'üçõ'},
        {k:'„Åò„ÇÖ„Éº„Åô',    r:'ju-su',       j:'„Ç∏„É•„Éº„Çπ',     e:'ü•§'},
        {k:'„Åë„Éº„Åç',      r:'ke-ki',       j:'„Ç±„Éº„Ç≠',       e:'üéÇ'},
        {k:'„Å°„Éº„Åö',      r:'ti-zu',      j:'„ÉÅ„Éº„Ç∫',       e:'üßÄ'},
        {k:'„Åô„Éº„Å∑',      r:'su-pu',       j:'„Çπ„Éº„Éó',       e:'üç≤'},
        {k:'„Åú„Çä„Éº',      r:'zeri-',       j:'„Çº„É™„Éº',       e:'üçÆ'},
        {k:'„Åù„Éº„Åõ„Éº„Åò',  r:'so-se-ji',    j:'„ÇΩ„Éº„Çª„Éº„Ç∏',   e:'üå≠'},
        {k:'„ÅØ„Çì„Å∞„Éº„Åê',  r:'hanba-gu',    j:'„Éè„É≥„Éê„Éº„Ç∞',   e:'üçî'},
        {k:'„Å±„Çì„Åë„Éº„Åç',  r:'panke-ki',    j:'„Éë„É≥„Ç±„Éº„Ç≠',   e:'ü•û'},
        {k:'„ÅÆ„Éº„Å®',      r:'no-to',       j:'„Éé„Éº„Éà',       e:'üìì'},
        {k:'„Åó„Éº„Çã',      r:'shi-ru',      j:'„Ç∑„Éº„É´',       e:'‚≠ê'},
        {k:'„Åº„Éº„Çã„Å∫„Çì',  r:'bo-rupenn',   j:'„Éú„Éº„É´„Éö„É≥',   e:'üñäÔ∏è'},
        {k:'„Åô„Å®„Éº„Å∂',    r:'suto-bu',     j:'„Çπ„Éà„Éº„Éñ',     e:'üî•'},
        {k:'„Åù„Åµ„ÅÅ„Éº',    r:'sofa-',       j:'„ÇΩ„Éï„Ç°„Éº',     e:'üõãÔ∏è'},
        {k:'„Åü„Åè„Åó„Éº',    r:'takushi-',    j:'„Çø„ÇØ„Ç∑„Éº',     e:'üöï'},
        {k:'„Åà„Çå„Åπ„Éº„Åü„Éº',r:'erebe-ta-',   j:'„Ç®„É¨„Éô„Éº„Çø„Éº', e:'üõó'},
        {k:'„Åà„Åô„Åã„Çå„Éº„Åü„Éº',r:'esukare-ta-',j:'„Ç®„Çπ„Ç´„É¨„Éº„Çø„Éº',e:'üè¨'},
        {k:'„Åô„Éº„Å±„Éº',    r:'su-pa-',      j:'„Çπ„Éº„Éë„Éº',     e:'üõí'},
        {k:'„Åß„Å±„Éº„Å®',    r:'depa-to',     j:'„Éá„Éë„Éº„Éà',     e:'üè™'},
    ],
    '„Åä„Åä': [
        {k:'„Åä„Åä„Åç„ÅÑ',   r:'ookii',      j:'Â§ß„Åç„ÅÑ',    e:'üêò'},
        {k:'„Åä„Åä„ÅÑ',     r:'ooi',        j:'Â§ö„ÅÑ',      e:'‚≠ê'},
        {k:'„Åä„Åä„ÇÄ„Å≠',   r:'oomune',     j:'Ê¶Ç„Å≠',      e:'üëç'},
        {k:'„Åì„Åä„Çä',     r:'koori',      j:'Ê∞∑',        e:'üßä'},
        {k:'„Åì„Åä„Çç„Åé',   r:'koorogi',    j:'ËüãËüÄ',      e:'ü¶ó'},
        {k:'„Åª„Åä',       r:'hoo',        j:'È†¨',        e:'üòä'},
        {k:'„Åª„Åä„Åö„Åç',   r:'hoozuki',    j:'È¨ºÁÅØ',      e:'üèÆ'},
        {k:'„Åª„Åä„Åò„Çç',   r:'hoojiro',    j:'È†¨ÁôΩ',      e:'üê¶'},
        {k:'„Å®„Åä',       r:'too',        j:'ÂçÅ',        e:'üîü'},
        {k:'„Å®„Åä„Åã',     r:'tooka',      j:'ÂçÅÊó•',      e:'üìÖ'},
        {k:'„Å®„Åä„Åè',     r:'tooku',      j:'ÈÅ†„Åè',      e:'üåÖ'},
        {k:'„Å®„Åä„Çã',     r:'tooru',      j:'ÈÄö„Çã',      e:'üö∂'},
        {k:'„Å®„Åä„Åó',     r:'tooshi',     j:'ÈÄö„Åó',      e:'üé´'},
        {k:'„Åä„Åä„Åã„Åø',   r:'ookami',     j:'Áãº',        e:'üê∫'},
        {k:'„Åä„Åä„ÇÑ„Åë',   r:'ooyake',     j:'ÂÖ¨',        e:'üèõÔ∏è'},
        {k:'„Åì„Åä„Çã',     r:'kooru',      j:'Âáç„Çã',      e:'‚ùÑÔ∏è'},
        {k:'„ÅÑ„Å®„Åä„Åó„ÅÑ', r:'itooshii',   j:'ÊÑõ„Åä„Åó„ÅÑ',  e:'üíï'},
    ],
    '„Åä„ÅÜ': [
        {k:'„Åä„ÅÜ„Åï„Åæ',      r:'ousama',       j:'ÁéãÊßò',      e:'üëë'},
        {k:'„Åä„Å®„ÅÜ„Åï„Çì',    r:'otousann',     j:'„ÅäÁà∂„Åï„Çì',  e:'üë®'},
        {k:'„ÅÑ„ÇÇ„ÅÜ„Å®',      r:'imouto',       j:'Â¶π',        e:'üëß'},
        {k:'„Åä„Å®„ÅÜ„Å®',      r:'otouto',       j:'Âºü',        e:'üë¶'},
        {k:'„Åç„Çá„ÅÜ',        r:'kyou',         j:'‰ªäÊó•',      e:'üìÜ'},
        {k:'„Åç„Çá„ÅÜ„Çä„ÇÖ„ÅÜ',  r:'kyouryuu',     j:'ÊÅêÁ´ú',      e:'ü¶ï'},
        {k:'„Å≥„Çá„ÅÜ„ÅÑ„Çì',    r:'byouinn',      j:'ÁóÖÈô¢',      e:'üè•'},
        {k:'„Çä„Çá„ÅÜ„Çä',      r:'ryouri',       j:'ÊñôÁêÜ',      e:'üç≥'},
        {k:'„Åå„Å£„Åì„ÅÜ',      r:'gakkou',       j:'Â≠¶Ê†°',      e:'üè´'},
        {k:'„Åπ„Çì„Åç„Çá„ÅÜ',    r:'benkyou',      j:'ÂãâÂº∑',      e:'üìö'},
        {k:'„Å≤„Çá„ÅÜ„Åò„Çá„ÅÜ',  r:'hyoujou',      j:'Ë°®ÊÉÖ',      e:'üòÑ'},
        {k:'„Åª„ÅÜ„Åç',        r:'houki',        j:'ÁÆí',        e:'üßπ'},
        {k:'„Åº„ÅÜ„Åó',        r:'boushi',       j:'Â∏ΩÂ≠ê',      e:'üé©'},
        {k:'„Åû„ÅÜ',          r:'zou',          j:'Ë±°',        e:'üêò'},
        {k:'„Å°„Çá„ÅÜ„Å°„Çá',    r:'tyoutyo',      j:'Ëù∂„ÄÖ',      e:'ü¶ã'},
        {k:'„Åç„ÇÖ„ÅÜ„Åç„ÇÖ„ÅÜ„Åó„ÇÉ',r:'kyuukyuusha',j:'ÊïëÊÄ•Ëªä',    e:'üöë'},
        {k:'„Åó„Çá„ÅÜ„Åº„ÅÜ„Åó„ÇÉ',r:'shoubosha',    j:'Ê∂àÈò≤Ëªä',    e:'üöí'},
        {k:'„Åò„Çá„ÅÜ„Åö',      r:'jouzu',        j:'‰∏äÊâã',      e:'üëè'},
        {k:'„Å≤„Çá„ÅÜ',        r:'hyou',         j:'Ë±π',        e:'üêÜ'},
        {k:'„Åì„ÅÜ„Åà„Çì',      r:'kouen',        j:'ÂÖ¨Âúí',      e:'üå≥'},
        {k:'„Åì„ÅÜ„Åò„Çá„ÅÜ',    r:'koujou',       j:'Â∑•Â†¥',      e:'üè≠'},
        {k:'„Åä„Åó„Çá„ÅÜ„Åå„Å§',  r:'oshougatsu',   j:'„ÅäÊ≠£Êúà',    e:'üéç'},
        {k:'„Å®„ÅÜ„ÇÇ„Çç„Åì„Åó',  r:'toumorokoshi', j:'ÁéâËúÄÈªç',    e:'üåΩ'},
        {k:'„Çç„ÅÜ„Åù„Åè',      r:'rousoku',      j:'ËùãÁá≠',      e:'üïØÔ∏è'},
        {k:'„Åª„ÅÜ„Çå„Çì„Åù„ÅÜ',  r:'hourensou',    j:'Ëè†ËñêËçâ',    e:'ü•¨'},
        {k:'„Å∂„Å©„ÅÜ',        r:'budou',        j:'Ëë°ËêÑ',      e:'üçá'},
        {k:'„Åï„Å®„ÅÜ',        r:'satou',        j:'Á†ÇÁ≥ñ',      e:'üç¨'},
        {k:'„Åì„Çì„Åò„Çá„ÅÜ',    r:'konnjou',      j:'Ê†πÊÄß',      e:'üí™'},
        {k:'„Åº„ÅÜ„Åë„Çì',      r:'boukenn',      j:'ÂÜíÈô∫',      e:'üó∫Ô∏è'},
        {k:'„Åï„Çà„ÅÜ„Å™„Çâ',    r:'sayounara',    j:'„Åï„Çà„ÅÜ„Å™„Çâ',e:'üëã'},
    ],
};

const gairaiData = {
    '„É¥Ë°å': [
        {k:'„É¥„Ç°',r:'va'},{k:'„É¥„Ç£',r:'vi'},{k:'„É¥',r:'vu'},{k:'„É¥„Çß',r:'ve'},{k:'„É¥„Ç©',r:'vo'},
    ],
    '„Éï„Ç°Ë°å': [
        {k:'„Éï„Ç°',r:'fa'},{k:'„Éï„Ç£',r:'fi'},{k:'„Éï„Çß',r:'fe'},{k:'„Éï„Ç©',r:'fo'},
    ],
    '„ÉÜ„Ç£„Éª„Éá„Ç£Á≥ª': [
        {k:'„ÉÜ„Ç£',r:'thi'},{k:'„Éá„Ç£',r:'dhi'},{k:'„Éà„Ç•',r:'twu'},{k:'„Éâ„Ç•',r:'dwu'},{k:'„Éá„É•',r:'dyu'},
    ],
    '„ÉÅ„Çß„Éª„Ç∑„Çß„Éª„Ç∏„Çß': [
        {k:'„ÉÅ„Çß',r:'tye'},{k:'„Ç∑„Çß',r:'she'},{k:'„Ç∏„Çß',r:'je'},{k:'„Ç§„Çß',r:'ye'},
    ],
    '„Ç¶„Ç£„Éª„Ç¶„Çß„Éª„Ç¶„Ç©': [
        {k:'„Ç¶„Ç£',r:'wi'},{k:'„Ç¶„Çß',r:'we'},{k:'„Ç¶„Ç©',r:'wo'},
    ],
};

// =====================================================
// Áä∂ÊÖã
// =====================================================
let currentMode  = '';
let currentGroup = '';
let currentGroupIndex = 0;
let wordList   = [];
let wordIndex  = 0;
let typedCount = 0;
let cleared    = 0;

// =====================================================
// ÁîªÈù¢ÈÅ∑Áßª
// =====================================================
function goTo(name) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen-' + name).classList.add('active');
}

// =====================================================
// „É¢„Éº„ÉâÂà•„Ç∞„É´„Éº„Éó„Ç≠„ÉºÂèñÂæó
// =====================================================
function getGroupKeys(mode) {
    if (mode === 'boin')      return Object.keys(boinData);
    if (mode === 'gyou')      return Object.keys(gyouData);
    if (mode === 'dakuon')    return [...Object.keys(dakuonData), '„Åæ„Å®„ÇÅ„Å¶'];
    if (mode === 'tokubetsu') return [...Object.keys(tokubetsuData), '„Åæ„Å®„ÇÅ„Å¶'];
    if (mode === 'nobashi')   return Object.keys(nobashiData);
    if (mode === 'gairai')    return [...Object.keys(gairaiData), '„Åæ„Å®„ÇÅ„Å¶'];
    return [];
}

// =====================================================
// „É¢„Éº„ÉâÈÅ∏Êäû ‚Üí ÈÅ∏ÊäûÁîªÈù¢ÁîüÊàê
// =====================================================
function selectMode(mode) {
    currentMode = mode;

    const labels = {
        boin:'ÊØçÈü≥„É¢„Éº„Éâ', gyou:'Ë°å„É¢„Éº„Éâ',
        dakuon:'ÊøÅÈü≥„É¢„Éº„Éâ', tokubetsu:'ÁâπÊÆä„É¢„Éº„Éâ',
        nobashi:'„ÅÆ„Å∞„Åó„É¢„Éº„Éâ', gairai:'Â§ñÊù•Ë™ûÈü≥„É¢„Éº„Éâ'
    };
    const headings = {
        boin:'„Å©„ÅÆÊÆµ„ÇíÁ∑¥Áøí„Åô„ÇãÔºü', gyou:'„Å©„ÅÆË°å„ÇíÁ∑¥Áøí„Åô„ÇãÔºü',
        dakuon:'„Å©„ÅÆË°å„ÇíÁ∑¥Áøí„Åô„ÇãÔºü', tokubetsu:'„Å©„ÅÆË°å„ÇíÁ∑¥Áøí„Åô„ÇãÔºü',
        nobashi:'„Å©„ÅÆ„Ç≥„Éº„Çπ„ÇíÁ∑¥Áøí„Åô„ÇãÔºü', gairai:'„Å©„ÅÆ„Ç∞„É´„Éº„Éó„ÇíÁ∑¥Áøí„Åô„ÇãÔºü'
    };
    const subs = {
        boin:'Âêå„ÅòÊØçÈü≥Ôºàa/i/u/e/oÔºâ„Åß„Åæ„Å®„ÇÅ„Å¶Á∑¥Áøí',
        gyou:'Âêå„ÅòÂ≠êÈü≥Ôºàk/s/t‚Ä¶Ôºâ„Åß„Åæ„Å®„ÇÅ„Å¶Á∑¥Áøí',
        dakuon:'ÊøÅÈü≥„ÉªÂçäÊøÅÈü≥„ÅÆË°å„Åî„Å®„ÄÅ„Åæ„Åü„ÅØ„Åæ„Å®„ÇÅ„Å¶',
        tokubetsu:'ÊãóÈü≥Ôºà„Åç„ÇÉ„Éª„Åó„ÇÉ‚Ä¶Ôºâ„ÅÆË°å„Åî„Å®„ÄÅ„Åæ„Åü„ÅØ„Åæ„Å®„ÇÅ„Å¶„ÄÇ„Å£„ÅÆÂÖ•ÂäõÁ∑¥Áøí„ÇÇÂê´„ÇÄ',
        nobashi:'„Éº„Éª„Åä„Åä„Éª„Åä„ÅÜ„ÄÅ„Åù„Çå„Åû„Çå„ÅÆ‰º∏„Å∞„ÅóÊñπ„ÇíÁ∑¥Áøí',
        gairai:'Â§ñÊù•Ë™ûÁâπÊúâ„ÅÆÈü≥Ôºà„É¥„Éª„Éï„Ç°„Éª„ÉÜ„Ç£‚Ä¶Ôºâ„Çí„Ç∞„É´„Éº„ÉóÂà•„ÄÅ„Åæ„Åü„ÅØ„Åæ„Å®„ÇÅ„Å¶',
    };

    document.getElementById('sel-label').textContent   = labels[mode];
    document.getElementById('sel-heading').textContent = headings[mode];
    document.getElementById('sel-sub').textContent     = subs[mode];

    const grid = document.getElementById('sel-grid');
    grid.innerHTML = '';
    grid.className = 'select-grid mode-' + mode;

    const keys = getGroupKeys(mode);

    keys.forEach((key, idx) => {
        if (key === '„Åæ„Å®„ÇÅ„Å¶') {
            const btn = document.createElement('button');
            btn.className = 'btn-matomete';
            btn.innerHTML = 'üîÄ „Åæ„Å®„ÇÅ„Å¶Ôºà„É©„É≥„ÉÄ„É†Ôºâ';
            btn.onclick = () => startGame(key, idx);
            grid.appendChild(btn);
            return;
        }

        // „Çµ„Éñ„É©„Éô„É´„Éª„Åã„Å™„Éó„É¨„Éì„É•„Éº
        let subLabel = '';
        let kanaPreview = '';
        if (mode === 'boin') {
            subLabel = 'DAN ' + (idx + 1);
            const src = boinData[key];
            kanaPreview = src.map(d => d.k).join('');
        } else if (mode === 'gyou') {
            subLabel = 'GYO ' + (idx + 1);
            kanaPreview = gyouData[key].map(d => d.k).join('');
        } else if (mode === 'dakuon') {
            subLabel = 'ROW ' + (idx + 1);
            kanaPreview = dakuonData[key].map(d => d.k).join('');
        } else if (mode === 'tokubetsu') {
            subLabel = 'ROW ' + (idx + 1);
            kanaPreview = tokubetsuData[key].map(d => d.k).join('');
        } else if (mode === 'nobashi') {
            const counts = {'„ÉºÔºàÂ§ñÊù•Ë™ûÔºâ':20,'„Åä„Åä':17,'„Åä„ÅÜ':30};
            subLabel = 'COURSE ' + (idx + 1);
            kanaPreview = counts[key] + 'Ë™û';
        }

        const btn = document.createElement('button');
        btn.className = 'select-btn';
        btn.innerHTML = `
            <div class="sn">${subLabel}</div>
            <div class="sm">${key}</div>
            <div class="sk">${kanaPreview}</div>
        `;
        btn.onclick = () => startGame(key, idx);
        grid.appendChild(btn);
    });

    goTo('select');
}

// =====================================================
// „Ç≤„Éº„É†ÈñãÂßã
// =====================================================
function startGame(group, groupIndex) {
    currentGroup      = group;
    currentGroupIndex = groupIndex;
    wordIndex  = 0;
    typedCount = 0;
    cleared    = 0;

    // „Éá„Éº„ÇøÂèñÂæó
    if (currentMode === 'boin')           wordList = [...boinData[group]];
    else if (currentMode === 'gyou')      wordList = [...gyouData[group]];
    else if (currentMode === 'dakuon') {
        wordList = group === '„Åæ„Å®„ÇÅ„Å¶'
            ? shuffle(Object.values(dakuonData).flat())
            : [...dakuonData[group]];
    } else if (currentMode === 'tokubetsu') {
        wordList = group === '„Åæ„Å®„ÇÅ„Å¶'
            ? shuffle(Object.values(tokubetsuData).flat())
            : [...tokubetsuData[group]];
    } else if (currentMode === 'nobashi') {
        wordList = [...nobashiData[group]];
    } else if (currentMode === 'gairai') {
        wordList = group === '„Åæ„Å®„ÇÅ„Å¶'
            ? shuffle(Object.values(gairaiData).flat())
            : [...gairaiData[group]];
    }

    // „Éê„ÉÉ„Ç∏
    const badge = document.getElementById('game-badge');
    const modeLabels = {boin:'ÊØçÈü≥',gyou:'Ë°å',dakuon:'ÊøÅÈü≥',tokubetsu:'ÁâπÊÆä',nobashi:'„ÅÆ„Å∞„Åó',gairai:'Â§ñÊù•Ë™û'};
    badge.textContent = modeLabels[currentMode];
    badge.className   = 'game-badge gb-' + currentMode;

    // „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà
    document.getElementById('char-ctx').textContent = group;

    buildDots();
    goTo('game');
    loadItem();

    // „Ç™„Éº„Éê„Éº„É¨„Ç§Ë°®Á§∫ÔºàiPadÂØæÂøúÔºâ
    document.getElementById('start-overlay').style.display = 'flex';
}

// =====================================================
// „Ç¢„Ç§„ÉÜ„É†„É≠„Éº„Éâ
// =====================================================
function loadItem() {
    if (wordIndex >= wordList.length) {
        showResult();
        return;
    }

    typedCount = 0;
    const item = wordList[wordIndex];

    // ÊñáÂ≠ó„Çµ„Ç§„Ç∫Ëá™ÂãïË™øÊï¥
    const disp = document.getElementById('char-disp');
    const len  = item.k.length;
    disp.className = 'char-display ' +
        (len <= 2 ? 'size-lg' : len <= 4 ? 'size-md' : len <= 6 ? 'size-sm' : 'size-xs');
    disp.textContent = item.k;

    // „ÅÆ„Å∞„Åó„Éª‰øÉÈü≥Ë™û„ÅØÊº¢Â≠ó„ÉªÁµµÊñáÂ≠ó„ÇíË°®Á§∫
    const kanjiEl = document.getElementById('char-kanji');
    const emojiEl = document.getElementById('char-emoji');
    if (currentMode === 'nobashi' || (currentMode === 'tokubetsu' && item.j)) {
        kanjiEl.textContent = item.j || '';
        emojiEl.textContent = item.e || '';
    } else {
        kanjiEl.textContent = '';
        emojiEl.textContent = '';
    }

    document.getElementById('game-prog').textContent =
        `${wordIndex + 1} / ${wordList.length}`;

    renderBoxes(item.r);
    updateDots();
}

// =====================================================
// „É≠„Éº„ÉûÂ≠ó„Éú„ÉÉ„ÇØ„ÇπÊèèÁîª
// =====================================================
function renderBoxes(romaji) {
    const wrap = document.getElementById('romaji-disp');
    wrap.innerHTML = '';
    // Èï∑„ÅÑÂçòË™û„ÅØÂ∞è„Åï„ÅÑ„Éú„ÉÉ„ÇØ„Çπ„Å´
    const narrow = romaji.length > 8;
    for (let i = 0; i < romaji.length; i++) {
        const box = document.createElement('div');
        box.className = 'r-box ' + (narrow ? 'r-box-narrow' : 'r-box-wide') +
            (i === 0 ? ' cur-' + currentMode : '');
        box.textContent  = romaji[i];
        box.dataset.idx  = i;
        wrap.appendChild(box);
    }
}

function getBox(idx) {
    return document.querySelector(`#romaji-disp .r-box[data-idx="${idx}"]`);
}

// =====================================================
// „Ç≠„ÉºÂÖ•Âäõ
// =====================================================
document.getElementById('hidden-input').addEventListener('keydown', function(e) {
    if (e.key === 'Backspace' || e.key.length !== 1) return;
    const key = e.key.toLowerCase();
    if (!/^[a-z\-]$/.test(key)) return;
    e.preventDefault();
    handleKey(key);
});

function handleKey(key) {
    const romaji   = wordList[wordIndex].r;
    const expected = romaji[typedCount];
    const curClass = 'cur-' + currentMode;

    if (key === expected) {
        const box = getBox(typedCount);
        if (box) { box.classList.remove(curClass, 'wrong'); box.classList.add('typed'); }
        typedCount++;
        const nb = getBox(typedCount);
        if (nb) nb.classList.add(curClass);

        if (typedCount >= romaji.length) {
            cleared++;
            const card = document.getElementById('char-card');
            card.classList.add('pop');
            setTimeout(() => card.classList.remove('pop'), 340);
            // Á¥ôÂêπÈõ™ÔºÅ
            spawnConfetti(card);
            wordIndex++;
            setTimeout(loadItem, 280);
        }
    } else {
        const box = getBox(typedCount);
        if (box) {
            box.classList.remove('wrong');
            void box.offsetWidth;
            box.classList.add('wrong');
            setTimeout(() => {
                box.classList.remove('wrong');
                box.classList.add(curClass);
            }, 350);
        }
    }
}

// =====================================================
// ÈÄ≤Êçó„Éâ„ÉÉ„Éà
// =====================================================
function buildDots() {
    const wrap = document.getElementById('prog-dots');
    wrap.innerHTML = '';
    wordList.forEach((_, i) => {
        const d = document.createElement('div');
        d.className = 'dot';
        d.dataset.di = i;
        wrap.appendChild(d);
    });
    updateDots();
}

function updateDots() {
    document.querySelectorAll('#prog-dots .dot').forEach((d, i) => {
        d.className = 'dot';
        if (i < wordIndex)   d.classList.add('done-' + currentMode);
        if (i === wordIndex) d.classList.add('act-'  + currentMode);
    });
}

// =====================================================
// ÈñãÂßã„Ç™„Éº„Éê„Éº„É¨„Ç§
// =====================================================
function activateInput() {
    document.getElementById('start-overlay').style.display = 'none';
    document.getElementById('hidden-input').focus();
}

// =====================================================
// Á¥ôÂêπÈõ™„Ç®„Éï„Çß„ÇØ„Éà
// =====================================================
const CONFETTI_CHARS = ['‚≠ê','üåü','‚ú®','üí´','üéâ','üéä','‚ö°','üå∏','üí•'];
const CONFETTI_COLORS = ['#ffd60a','#ff8c00','#4cc9f0','#4ade80','#f72585','#a855f7','#fff'];

function spawnConfetti(originEl) {
    const rect   = originEl.getBoundingClientRect();
    const cx     = rect.left + rect.width  / 2;
    const cy     = rect.top  + rect.height / 2;
    const count  = 14;

    for (let i = 0; i < count; i++) {
        const el = document.createElement('div');
        el.className = 'confetti-piece';

        // „É©„É≥„ÉÄ„É†„Å™ÊñπÂêë„ÉªË∑ùÈõ¢
        const angle = (Math.PI * 2 / count) * i + (Math.random() - 0.5) * 0.8;
        const dist  = 80 + Math.random() * 120;
        const tx    = Math.cos(angle) * dist;
        const ty    = Math.sin(angle) * dist - 60;
        const rot   = (Math.random() - 0.5) * 720 + 'deg';
        const dur   = (0.5 + Math.random() * 0.4) + 's';

        el.style.cssText = `
            left: ${cx}px; top: ${cy}px;
            --tx: ${tx}px; --ty: ${ty}px;
            --rot: ${rot}; --dur: ${dur};
            color: ${CONFETTI_COLORS[i % CONFETTI_COLORS.length]};
        `;
        el.textContent = CONFETTI_CHARS[i % CONFETTI_CHARS.length];
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1000);
    }
}

// =====================================================
// Ëä±ÁÅ´„Ç®„Éï„Çß„ÇØ„ÉàÔºàÁµêÊûúÁîªÈù¢Ôºâ
// =====================================================
let fwCanvas, fwCtx, fwParticles = [], fwTimer = null;

function startFireworks() {
    fwCanvas = document.getElementById('fireworks-canvas');
    fwCanvas.width  = window.innerWidth;
    fwCanvas.height = window.innerHeight;
    fwCtx = fwCanvas.getContext('2d');
    fwParticles = [];

    // 5ÁßíÈñìËä±ÁÅ´„ÇíÊâì„Å°‰∏ä„Åí„Çã
    let launchCount = 0;
    const launch = () => {
        if (launchCount >= 12) return;
        launchFirework();
        launchCount++;
        setTimeout(launch, 350 + Math.random() * 400);
    };
    launch();
    requestAnimationFrame(fwLoop);
    // 5ÁßíÂæå„Å´„Ç≠„É£„É≥„Éê„Çπ„Çí„ÇØ„É™„Ç¢
    setTimeout(stopFireworks, 5000);
}

function launchFirework() {
    const x = window.innerWidth  * (0.2 + Math.random() * 0.6);
    const y = window.innerHeight * (0.15 + Math.random() * 0.45);
    const hue = Math.random() * 360;
    const count = 60 + Math.floor(Math.random() * 30);
    for (let i = 0; i < count; i++) {
        const angle  = (Math.PI * 2 / count) * i;
        const speed  = 2 + Math.random() * 4;
        fwParticles.push({
            x, y,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            alpha: 1,
            color: `hsl(${hue + Math.random() * 40},100%,60%)`,
            size: 2 + Math.random() * 2,
        });
    }
}

function fwLoop() {
    if (!fwCtx) return;
    fwCtx.clearRect(0, 0, fwCanvas.width, fwCanvas.height);
    fwParticles = fwParticles.filter(p => p.alpha > 0.02);
    fwParticles.forEach(p => {
        p.x  += p.vx;
        p.y  += p.vy;
        p.vy += 0.08;  // ÈáçÂäõ
        p.vx *= 0.97;
        p.alpha -= 0.018;
        fwCtx.globalAlpha = p.alpha;
        fwCtx.fillStyle   = p.color;
        fwCtx.beginPath();
        fwCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        fwCtx.fill();
    });
    fwCtx.globalAlpha = 1;
    if (fwParticles.length > 0 || fwCanvas.style.display !== 'none') {
        requestAnimationFrame(fwLoop);
    }
}

function stopFireworks() {
    setTimeout(() => {
        if (fwCtx) fwCtx.clearRect(0, 0, fwCanvas.width, fwCanvas.height);
        fwParticles = [];
    }, 2000);
}

// =====================================================
// ÁµêÊûú
// =====================================================
function showResult() {
    document.getElementById('res-msg').textContent =
        `„Äå${currentGroup}„Äç„Åú„Çì„Å∂„Åß„Åç„ÅüÔºÅ`;
    document.getElementById('res-count').textContent = cleared;

    // Ê¨°„Å∏„Éú„Çø„É≥
    const keys    = getGroupKeys(currentMode);
    const nextIdx = currentGroupIndex + 1;
    const nextBtn = document.getElementById('btn-next');
    if (nextIdx < keys.length) {
        nextBtn.style.display = 'block';
        const nextKey = keys[nextIdx];
        nextBtn.textContent = `‚ñ∂ Ê¨°„Å∏Ôºà${nextKey}Ôºâ`;
        nextBtn.onclick = () => startGame(nextKey, nextIdx);
    } else {
        nextBtn.style.display = 'none';
    }

    goTo('result');
    startFireworks();
}

function retryGame() { startGame(currentGroup, currentGroupIndex); }
function quitGame()  { goTo('select'); }

// ÁµêÊûúÁîªÈù¢ or „Ç™„Éº„Éê„Éº„É¨„Ç§Ë°®Á§∫‰∏≠„Å´Enter„ÅßÈÄ≤„ÇÄ
document.addEventListener('keydown', function(e) {
    if (e.key !== 'Enter') return;

    // „Ç™„Éº„Éê„Éº„É¨„Ç§„ÅåÂá∫„Å¶„ÅÑ„Çã„Å®„Åç
    const overlay = document.getElementById('start-overlay');
    if (overlay && overlay.style.display !== 'none') {
        e.preventDefault();
        activateInput();
        return;
    }

    // ÁµêÊûúÁîªÈù¢„ÅÆ„Å®„Åç
    if (!document.getElementById('screen-result').classList.contains('active')) return;
    e.preventDefault();
    const nextBtn = document.getElementById('btn-next');
    if (nextBtn.style.display !== 'none') {
        nextBtn.click();
    } else {
        retryGame();
    }
});

// =====================================================
// „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
// =====================================================
function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

// „Çø„ÉÉ„Éó„Åß„Éï„Ç©„Éº„Ç´„ÇπÁ∂≠ÊåÅ
['char-card','romaji-disp'].forEach(id => {
    document.getElementById(id).addEventListener('click', () => {
        document.getElementById('hidden-input').focus();
    });
});

function activateInput() {
    document.getElementById('start-overlay').style.display = 'none';
    document.getElementById('hidden-input').focus();
}

// „Ç≤„Éº„É†ÁîªÈù¢„ÇØ„É™„ÉÉ„ÇØ„ÅßÂ∏∏„Å´„Éï„Ç©„Éº„Ç´„Çπ
document.getElementById('screen-game').addEventListener('click', () => {
    document.getElementById('hidden-input').focus();
});
</script>
</body>
</html>
